# mistinguette


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->

## WIP

## Install

``` sh
pip install mistinguette
```

## Getting started

OpenAI‚Äôs Python SDK will automatically be installed with Cosette, if you
don‚Äôt already have it.

``` python
from mistinguette import *
```

Cosette only exports the symbols that are needed to use the library, so
you can use `import *` to import them. Alternatively, just use:

``` python
import mistinguette
```

‚Ä¶and then add the prefix `mistinguette.` to any usages of the module.

<!-- Cosette provides `models`, which is a list of models currently available from the SDK. -->

``` python
models
```

    ['codestral-2501',
     'mistral-large-2411',
     'pixtral-large-2411',
     'mistral-saba-2502',
     'ministral-3b-2410',
     'ministral-8b-2410',
     'mistral-embed-2312',
     'mistral-moderation-2411',
     'mistral-ocr-2503',
     'mistral-small-2503',
     'open-mistral-nemo-2407']

For these examples, we‚Äôll use `mistral-large-2411`.

``` python
model = models[1]
```

## Chat

The main interface to Cosette is the
[`Chat`](https://franckalbinet.github.io/mistinguette/core.html#chat)
class, which provides a stateful interface to the models:

``` python
chat = Chat(model, sp="""You are a helpful and concise assistant.""")
chat("I'm Jeremy")
```

Hello Jeremy! Nice to meet you. How can I assist you today? Let‚Äôs have a
concise and productive conversation.

<details>

- id: 0a378d32527e4a748b1db3fa57dffce5
- object: chat.completion
- model: mistral-large-2411
- usage: prompt_tokens=18 completion_tokens=27 total_tokens=45
- created: 1743585664
- choices: \[ChatCompletionChoice(index=0,
  message=AssistantMessage(content=‚ÄúHello Jeremy! Nice to meet you. How
  can I assist you today? Let‚Äôs have a concise and productive
  conversation.‚Äù, tool_calls=None, prefix=False, role=‚Äòassistant‚Äô),
  finish_reason=‚Äòstop‚Äô)\]

</details>

``` python
r = chat("What's my name?")
r
```

Jeremy

<details>

- id: dd3081c3261c48b7a5f18ad48a3851aa
- object: chat.completion
- model: mistral-large-2411
- usage: prompt_tokens=53 completion_tokens=2 total_tokens=55
- created: 1743585668
- choices: \[ChatCompletionChoice(index=0,
  message=AssistantMessage(content=‚ÄòJeremy‚Äô, tool_calls=None,
  prefix=False, role=‚Äòassistant‚Äô), finish_reason=‚Äòstop‚Äô)\]

</details>

As you see above, displaying the results of a call in a notebook shows
just the message contents, with the other details hidden behind a
collapsible section. Alternatively you can `print` the details:

``` python
print(r)
```

    id='a95cf007ff0f474a8c10d73550c91223' object='chat.completion' model='mistral-large-2411' usage=In: 43; Out: 9; Total: 52 created=1743585588 choices=[ChatCompletionChoice(index=0, message=AssistantMessage(content='You told me your name is Jeremy.', tool_calls=None, prefix=False, role='assistant'), finish_reason='stop')]

You can use `stream=True` to stream the results as soon as they arrive
(although you will only see the gradual generation if you execute the
notebook yourself, of course!)

``` python
for o in chat("What's your name?", stream=True): print(o, end='')
```

    I don't have a name. You can call me Assistant! How else can I help you today, Jeremy?

## Model Capabilities

Different Mistral AI models have different capabilities. For instance,
`mistral-large-2411` can not take an image as input as opposed to
`pixtral-large-2411`:

``` python
# o1 does not support streaming or setting the temperature
m = "mistral-large-2411"
can_stream(m), can_set_system_prompt(m), can_set_temperature(m), can_use_image(m)
```

    (True, True, True, False)

## Tool use

[Tool use](https://docs.openai.com/claude/docs/tool-use) lets the model
use external tools.

We use [docments](https://fastcore.fast.ai/docments.html) to make
defining Python functions as ergonomic as possible. Each parameter (and
the return value) should have a type, and a docments comment with the
description of what it is. As an example we‚Äôll write a simple function
that adds numbers together, and will tell us when it‚Äôs being called:

``` python
def sums(
    a:int,  # First thing to sum
    b:int=1 # Second thing to sum
) -> int: # The sum of the inputs
    "Adds a + b."
    print(f"Finding the sum of {a} and {b}")
    return a + b
```

Sometimes the model will say something like ‚Äúaccording to the `sums`
tool the answer is‚Äù ‚Äì generally we‚Äôd rather it just tells the user the
answer, so we can use a system prompt to help with this:

``` python
sp = "Never mention what tools you use."
```

We‚Äôll get the model to add up some long numbers:

``` python
a,b = 604542,6458932
pr = f"What is {a}+{b}?"
pr
```

    'What is 604542+6458932?'

To use tools, pass a list of them to
[`Chat`](https://franckalbinet.github.io/mistinguette/core.html#chat):

``` python
chat = Chat(model, sp=sp, tools=[sums])
```

Now when we call that with our prompt, the model doesn‚Äôt return the
answer, but instead returns a `tool_use` message, which means we have to
call the named tool with the provided parameters:

``` python
r = chat(pr)
r
```

The sum of 604542 and 6458932 is 7063474.

<details>

- id: a5c72a28430247bc900c561a2dd9efca
- object: chat.completion
- model: mistral-large-2411
- usage: prompt_tokens=132 completion_tokens=30 total_tokens=162
- created: 1743585694
- choices: \[ChatCompletionChoice(index=0,
  message=AssistantMessage(content=‚ÄòThe sum of 604542 and 6458932 is
  7063474.‚Äô, tool_calls=None, prefix=False, role=‚Äòassistant‚Äô),
  finish_reason=‚Äòstop‚Äô)\]

</details>

Cosette handles all that for us ‚Äì we just have to pass along the
message, and it all happens automatically:

``` python
chat()
```

    SDKError: API error occurred: Status 400
    {"object":"error","message":"Expected last role User or Tool (or Assistant with prefix True) for serving but got assistant","type":"invalid_request_error","param":null,"code":null}
    [0;31m---------------------------------------------------------------------------[0m
    [0;31mSDKError[0m                                  Traceback (most recent call last)
    Cell [0;32mIn[30], line 1[0m
    [0;32m----> 1[0m [43mchat[49m[43m([49m[43m)[49m

    File [0;32m~/pro/dev/mistinguette/mistinguette/core.py:279[0m, in [0;36m__call__[0;34m(self, pr, stream, **kwargs)[0m
    [1;32m    277[0m [38;5;28;01mif[39;00m [38;5;28mself[39m[38;5;241m.[39mtools: kwargs[[38;5;124m'[39m[38;5;124mtools[39m[38;5;124m'[39m] [38;5;241m=[39m [mk_mistralai_func(o) [38;5;28;01mfor[39;00m o [38;5;129;01min[39;00m [38;5;28mself[39m[38;5;241m.[39mtools]
    [1;32m    278[0m [38;5;28;01mif[39;00m [38;5;28mself[39m[38;5;241m.[39mtool_choice: kwargs[[38;5;124m'[39m[38;5;124mtool_choice[39m[38;5;124m'[39m] [38;5;241m=[39m mk_tool_choice([38;5;28mself[39m[38;5;241m.[39mtool_choice)
    [0;32m--> 279[0m res [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mc[49m[43m([49m[38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mh[49m[43m,[49m[43m [49m[43msp[49m[38;5;241;43m=[39;49m[38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43msp[49m[43m,[49m[43m [49m[43mstream[49m[38;5;241;43m=[39;49m[43mstream[49m[43m,[49m[43m [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mkwargs[49m[43m)[49m
    [1;32m    280[0m [38;5;28mself[39m[38;5;241m.[39mh [38;5;241m+[39m[38;5;241m=[39m mk_toolres(res, ns[38;5;241m=[39m[38;5;28mself[39m[38;5;241m.[39mtools)
    [1;32m    281[0m [38;5;28;01mreturn[39;00m res

    File [0;32m~/pro/dev/mistinguette/mistinguette/core.py:184[0m, in [0;36m__call__[0;34m(self, msgs, sp, maxtok, stream, **kwargs)[0m
    [1;32m    182[0m [38;5;28;01mif[39;00m sp [38;5;129;01mand[39;00m [38;5;28mself[39m[38;5;241m.[39mmodel [38;5;129;01min[39;00m has_system_prompt_models: msgs [38;5;241m=[39m [mk_msg(sp, [38;5;124m'[39m[38;5;124msystem[39m[38;5;124m'[39m)] [38;5;241m+[39m [38;5;28mlist[39m(msgs)
    [1;32m    183[0m chat_args [38;5;241m=[39m [38;5;28mdict[39m(model[38;5;241m=[39m[38;5;28mself[39m[38;5;241m.[39mmodel, messages[38;5;241m=[39mmsgs, max_tokens[38;5;241m=[39mmaxtok, [38;5;241m*[39m[38;5;241m*[39mkwargs)
    [0;32m--> 184[0m r [38;5;241m=[39m [38;5;28mself[39m[38;5;241m.[39mc[38;5;241m.[39mchat[38;5;241m.[39mstream([38;5;241m*[39m[38;5;241m*[39mchat_args) [38;5;28;01mif[39;00m stream [38;5;28;01melse[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mc[49m[38;5;241;43m.[39;49m[43mchat[49m[38;5;241;43m.[39;49m[43mcomplete[49m[43m([49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mchat_args[49m[43m)[49m
    [1;32m    185[0m [38;5;28;01mreturn[39;00m [38;5;28mself[39m[38;5;241m.[39m_r(r) [38;5;28;01mif[39;00m [38;5;129;01mnot[39;00m stream [38;5;28;01melse[39;00m get_stream([38;5;28mmap[39m([38;5;28mself[39m[38;5;241m.[39m_r, r))

    File [0;32m~/pro/dev/mistinguette/.venv/lib/python3.10/site-packages/mistralai/chat.py:243[0m, in [0;36mChat.complete[0;34m(self, model, messages, temperature, top_p, max_tokens, stream, stop, random_seed, response_format, tools, tool_choice, presence_penalty, frequency_penalty, n, prediction, parallel_tool_calls, safe_prompt, retries, server_url, timeout_ms, http_headers)[0m
    [1;32m    241[0m [38;5;28;01mif[39;00m utils[38;5;241m.[39mmatch_response(http_res, [38;5;124m"[39m[38;5;124m4XX[39m[38;5;124m"[39m, [38;5;124m"[39m[38;5;124m*[39m[38;5;124m"[39m):
    [1;32m    242[0m     http_res_text [38;5;241m=[39m utils[38;5;241m.[39mstream_to_text(http_res)
    [0;32m--> 243[0m     [38;5;28;01mraise[39;00m models[38;5;241m.[39mSDKError(
    [1;32m    244[0m         [38;5;124m"[39m[38;5;124mAPI error occurred[39m[38;5;124m"[39m, http_res[38;5;241m.[39mstatus_code, http_res_text, http_res
    [1;32m    245[0m     )
    [1;32m    246[0m [38;5;28;01mif[39;00m utils[38;5;241m.[39mmatch_response(http_res, [38;5;124m"[39m[38;5;124m5XX[39m[38;5;124m"[39m, [38;5;124m"[39m[38;5;124m*[39m[38;5;124m"[39m):
    [1;32m    247[0m     http_res_text [38;5;241m=[39m utils[38;5;241m.[39mstream_to_text(http_res)

    [0;31mSDKError[0m: API error occurred: Status 400
    {"object":"error","message":"Expected last role User or Tool (or Assistant with prefix True) for serving but got assistant","type":"invalid_request_error","param":null,"code":null}

You can see how many tokens have been used at any time by checking the
`use` property.

``` python
chat.use
```

    In: 204; Out: 41; Total: 245

### Tool loop

We can do everything needed to use tools in a single step, by using
[`Chat.toolloop`](https://franckalbinet.github.io/mistinguette/toolloop.html#chat.toolloop).
This can even call multiple tools as needed solve a problem. For
example, let‚Äôs define a tool to handle multiplication:

``` python
def mults(
    a:int,  # First thing to multiply
    b:int=1 # Second thing to multiply
) -> int: # The product of the inputs
    "Multiplies a * b."
    print(f"Finding the product of {a} and {b}")
    return a * b
```

Now with a single call we can calculate `(a+b)*2` ‚Äì by passing
`show_trace` we can see each response from the model in the process:

``` python
chat = Chat(model, sp=sp, tools=[sums,mults])
pr = f'Calculate ({a}+{b})*2'
pr
```

    'Calculate (604542+6458932)*2'

``` python
def pchoice(r): print(r.choices[0])
```

``` python
r = chat.toolloop(pr, trace_func=pchoice)
```

    Finding the sum of 604542 and 6458932
    Finding the product of 2 and 7103474
    Choice(finish_reason='tool_calls', index=0, logprobs=None, message=ChatCompletionMessage(content=None, refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_Sfet73hgfRtSI2N25K97D7tO', function=Function(arguments='{"a": 604542, "b": 6458932}', name='sums'), type='function'), ChatCompletionMessageToolCall(id='call_mFQNJgjATAI2pYFFQyvfg0W2', function=Function(arguments='{"a": 2, "b": 7103474}', name='mults'), type='function')]))
    Choice(finish_reason='stop', index=0, logprobs=None, message=ChatCompletionMessage(content='The result of \\((604542 + 6458932) \\times 2\\) is 14,206,948.', refusal=None, role='assistant', audio=None, function_call=None, tool_calls=None))

OpenAI uses special tags for math equations, which we can replace using
`wrap_latex`:

``` python
wrap_latex(contents(r))
```

The result of $(604542 + 6458932) \times 2$ is 14,206,948.

## Images

As everyone knows, when testing image APIs you have to use a cute puppy.

``` python
fn = Path('samples/puppy.jpg')
display.Image(filename=fn, width=200)
```

<img src="index_files/figure-commonmark/cell-22-output-1.jpeg"
width="200" />

We create a
[`Chat`](https://franckalbinet.github.io/mistinguette/core.html#chat)
object as before:

``` python
chat = Chat(model)
```

Claudia expects images as a list of bytes, so we read in the file:

``` python
img = fn.read_bytes()
```

Prompts to Claudia can be lists, containing text, images, or both, eg:

``` python
chat([img, "In brief, what color flowers are in this image?"])
```

The flowers in the image are purple.

<details>

- id: chatcmpl-AxxPrQeO00Ks5X93eKJQ1t6Dtqxu6
- choices: \[Choice(finish_reason=‚Äòstop‚Äô, index=0, logprobs=None,
  message=ChatCompletionMessage(content=‚ÄòThe flowers in the image are
  purple.‚Äô, refusal=None, role=‚Äòassistant‚Äô, audio=None,
  function_call=None, tool_calls=None))\]
- created: 1738853111
- model: gpt-4o-2024-08-06
- object: chat.completion
- service_tier: default
- system_fingerprint: fp_4691090a87
- usage: CompletionUsage(completion_tokens=9, prompt_tokens=458,
  total_tokens=467,
  completion_tokens_details=CompletionTokensDetails(accepted_prediction_tokens=0,
  audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0),
  prompt_tokens_details=PromptTokensDetails(audio_tokens=0,
  cached_tokens=0))

</details>

The image is included as input tokens.

``` python
chat.use
```

    In: 458; Out: 9; Total: 467

Alternatively, Cosette supports creating a multi-stage chat with
separate image and text prompts. For instance, you can pass just the
image as the initial prompt (in which case the model will make some
general comments about what it sees), and then follow up with questions
in additional prompts:

``` python
chat = Chat(model)
chat(img)
```

This is an image of a Cavalier King Charles Spaniel puppy lying on the
grass next to some purple flowers. The puppy has white and brown fur and
an adorable expression.

<details>

- id: chatcmpl-AxxPts6mRTeap94CEPIdf7INa5Xkx
- choices: \[Choice(finish_reason=‚Äòstop‚Äô, index=0, logprobs=None,
  message=ChatCompletionMessage(content=‚ÄòThis is an image of a Cavalier
  King Charles Spaniel puppy lying on the grass next to some purple
  flowers. The puppy has white and brown fur and an adorable
  expression.‚Äô, refusal=None, role=‚Äòassistant‚Äô, audio=None,
  function_call=None, tool_calls=None))\]
- created: 1738853113
- model: gpt-4o-2024-08-06
- object: chat.completion
- service_tier: default
- system_fingerprint: fp_4691090a87
- usage: CompletionUsage(completion_tokens=36, prompt_tokens=447,
  total_tokens=483,
  completion_tokens_details=CompletionTokensDetails(accepted_prediction_tokens=0,
  audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0),
  prompt_tokens_details=PromptTokensDetails(audio_tokens=0,
  cached_tokens=0))

</details>

``` python
chat('What direction is the puppy facing?')
```

The puppy is facing towards the camera.

<details>

- id: chatcmpl-AxxPuqxXMuefTG3ehawZW2rMll6co
- choices: \[Choice(finish_reason=‚Äòstop‚Äô, index=0, logprobs=None,
  message=ChatCompletionMessage(content=‚ÄòThe puppy is facing towards the
  camera.‚Äô, refusal=None, role=‚Äòassistant‚Äô, audio=None,
  function_call=None, tool_calls=None))\]
- created: 1738853114
- model: gpt-4o-2024-08-06
- object: chat.completion
- service_tier: default
- system_fingerprint: fp_4691090a87
- usage: CompletionUsage(completion_tokens=9, prompt_tokens=497,
  total_tokens=506,
  completion_tokens_details=CompletionTokensDetails(accepted_prediction_tokens=0,
  audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0),
  prompt_tokens_details=PromptTokensDetails(audio_tokens=0,
  cached_tokens=0))

</details>

``` python
chat('What color is it?')
```

The puppy is white with brown markings.

<details>

- id: chatcmpl-AxxPw64bsATMHf3a5Rzal8WjqgHRM
- choices: \[Choice(finish_reason=‚Äòstop‚Äô, index=0, logprobs=None,
  message=ChatCompletionMessage(content=‚ÄòThe puppy is white with brown
  markings.‚Äô, refusal=None, role=‚Äòassistant‚Äô, audio=None,
  function_call=None, tool_calls=None))\]
- created: 1738853116
- model: gpt-4o-2024-08-06
- object: chat.completion
- service_tier: default
- system_fingerprint: fp_4691090a87
- usage: CompletionUsage(completion_tokens=9, prompt_tokens=518,
  total_tokens=527,
  completion_tokens_details=CompletionTokensDetails(accepted_prediction_tokens=0,
  audio_tokens=0, reasoning_tokens=0, rejected_prediction_tokens=0),
  prompt_tokens_details=PromptTokensDetails(audio_tokens=0,
  cached_tokens=0))

</details>

Note that the image is passed in again for every input in the dialog, so
that number of input tokens increases quickly with this kind of chat.

``` python
chat.use
```

    In: 1462; Out: 54; Total: 1516
